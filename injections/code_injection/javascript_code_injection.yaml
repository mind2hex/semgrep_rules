rules:
  - id: javascript.code_injection
    languages: [javascript, typescript]
    severity: CRITICAL
    message: |
      Semgrep have found a possibly code injection vulnerability.
      This is a vulnerability that could lead to RCE.
    patterns:
      - pattern-either:
          # mathjs.evaluate
          - patterns:
              - pattern: |
                  mathjs.evaluate($OBJ)
              - pattern-not: |
                  mathjs.evaluate("...")

          # eval
          - patterns:
              - pattern: |
                  eval($OBJ)
              - pattern-not: |
                  eval("...")
          - patterns:
              - pattern: |
                  $A.eval($OBJ)
              - pattern-not: |
                  $A.eval("...")
          - patterns:
              - pattern: |
                  (..., eval)($OBJ)
              - pattern-not: |
                  (..., eval)("...")
          - patterns:
              - pattern: |
                  $ALIAS = eval;
                  ...
                  $ALIAS($OBJ)
              - pattern-not: |
                  $ALIAS = eval;
                  ...
                  $ALIAS("...")

          # Function
          - pattern: |
              new Function(..., "..." + $OBJ + "...")
          - pattern: |
              $BODY = "..." + $OBJ + "..."
              ...
              new Function(..., $BODY)
          - pattern: |
              new Function(..., `...${...}...`)
          - pattern: |
              $BODY = `...${...}...`
              ...
              new Function(..., $BODY)
          - pattern: |
              Function(..., "..." + $OBJ + "...")
          - pattern: |
              $BODY = "..." + $OBJ + "..."
              ...
              Function(..., $BODY)
          - pattern: |
              $BODY = `...${...}...`
              ...
              Function(..., $BODY)
          - pattern: |
              Function(..., `...${...}...`)

          # setTimeout
          - pattern: |
              setTimeout("..." + $OBJ + "...", ...)
          - pattern: |
              setTimeout(`...${...}...`, ...)
          - pattern: |
              setTimeout(..., $OBJ, ...)
            
          # setInterval
          - pattern: |
              setInterval("..." + $OBJ + "...", ...)
          - pattern: |
              setInterval(`...${...}...`, ...)
      - pattern-not: |
          setTimeout("...", ...)
      - pattern-not: |
          setInterval("...", ...)