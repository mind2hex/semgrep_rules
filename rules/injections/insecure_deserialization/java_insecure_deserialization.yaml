rules:
  - id: java.insecure_deserialization
    languages:
      - java
    message: |
      Semgrep found an insecure deserialization implementation
      in the application.
    severity: CRITICAL
    pattern-either:
      # ObjectInputStream 
      - patterns:
        - pattern-either:
            - pattern: |
                $FOO = new ObjectInputStream(..., $OBJ, ...);
                ...
                $FOO.readObject();
        - pattern-not: ObjectInputStream("...");

      # XMLDecoder
      - patterns:
          - pattern-either:
              - pattern: |
                  XMLDecoder $FOO = new XMLDecoder(..., $OBJ, ...);
                  ...
                  $FOO.readObject();
          - pattern-not: $FOO.readObject("...")
      
      # XStream
      - patterns:
          - pattern-either:
              - pattern: |
                  XStream $FOO = new XStream();
                  ...
                  $FOO.fromXML(..., $OBJ, ...);
      
      # ObjectMapper
      - patterns:
          - pattern-either:
              - pattern: |
                  ObjectMapper $FOO = new ObjectMapper();
                  ...
                  $FOO.activateDefaultTyping(..., LaissezFaireSubTypeValidator.instance, ObjectMapper.DefaultTyping.NON_FINAL, ...);
                  ...
                  $FOO.readValue(..., $OBJ, ...);
          - pattern-not: $FOO.readValue("...");
      
      # Apache Commons SerializationUtils
      - patterns: 
          - pattern-either:
              - pattern: | 
                  SerializationUtils.deserialize(..., $OBJ, ...);
          - pattern-not: |
                SerializationUtils.deserialize("...");
              