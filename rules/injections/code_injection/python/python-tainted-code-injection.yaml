rules:
  - id: python-tainted-code-injection
    languages: [python]
    severity: CRITICAL
    message: |
      Semgrep found a possible code injection vulnerability using taint analysis.
    mode: taint
    pattern-sources:
      - patterns:
          - pattern: request.$METHOD
          - metavariable-regex:
              metavariable: $METHOD
              regex: (GET|POST|body|path|path_info|content_params|query_params|data|FILES|META|headers|COOKIES|args|form|files|values|json|get_json|cookies|view_args|path_params|file|state|params|matchdict|json_body|query|forms|get_data)
      - patterns:
          - pattern: self.request.$METHOD
          - metavariable-regex:
              metavariable: $METHOD
              regex: (arguments|query_arguments|body_arguments|files|path_args|path_kwargs|headers|cookies)
      - pattern: self.get_argument(...)
      - patterns:
          - pattern: |
              def $FOO(..., $X, ...):
                ...
          - focus-metavariable: $X

    pattern-sinks:
      - pattern: eval(...)
      - pattern: exec(...)
      - pattern: compile(...)
      - pattern: importlib.import_module(...)
      - patterns: 
        - pattern: getattr(..., $ATTR)
        - focus-metavariable: $ATTR
      - pattern: __import__(...)
      - pattern: jinja2.Template(...)
      - pattern: pickle.loads(...)
      - pattern: yaml.load(...)
      - pattern: marshal.loads(...)
      - patterns: 
          - pattern: |
              $FOO = pandas.DataFrame(...)
              ...
          - pattern: $FOO.eval(...)
      - patterns: 
        - pattern: timeit.timeit($OBJ, ...)
        - focus-metavariable: $OBJ
              