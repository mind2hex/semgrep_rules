rules:
  - id: java-083-XML-Injection-XXE
    languages:
      - java
    message: It is possible to inject XML code into the application's requests,
      which is then interpreted by the server. This could allow an attacker to
      perform data exfiltration or execute commands remotely.
    severity: HIGH
    mode: taint
    pattern-sources:
      - pattern-either:
          - pattern: $REQUEST.getParameter(...)
          - pattern: $REQUEST.getParameterValues(...)
          - pattern: $REQUEST.getParameterMap()
          - pattern: $REQUEST.getQueryString()
          - pattern: $REQUEST.getHeader(...)
          - pattern: $REQUEST.getHeaders(...)
          - pattern: $REQUEST.getCookies()
      - pattern-either:
          - pattern: $REQUEST.getParameter(...)
          - pattern: $REQUEST.getParameterValues(...)
          - pattern: $REQUEST.getParameterMap()
          - pattern: $REQUEST.getQueryString()
          - pattern: $REQUEST.getInputStream()
          - pattern: $REQUEST.getReader()
      - pattern-either:
          - pattern: $RESULT_SET.getString(...)
          - pattern: $RESULT_SET.getObject(...)
          - pattern: $RESULT_SET.getInt(...)
          - pattern: $RESULT_SET.getLong(...)
          - pattern: $RESULT_SET.getFloat(...)
          - pattern: $RESULT_SET.getDouble(...)
          - pattern: $RESULT_SET.getBigDecimal(...)
          - pattern: $RESULT_SET.getDate(...)
          - pattern: $RESULT_SET.getTime(...)
          - pattern: $RESULT_SET.getTimestamp(...)
      - pattern-either:
          - pattern: $REQUEST.getParameter(...)
          - pattern: $REQUEST.getParameterValues(...)
          - pattern: $REQUEST.getParameterMap()
      - pattern-either:
          - pattern: public $RETURN_TYPE $METHOD_NAME(..., @RequestParam(...) $PARAM, ...) {
              ... }
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @PathVariable(...) $PARAM, ...) {
          ... }
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @RequestBody $PARAM, ...) { ... }
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @ModelAttribute(...) $PARAM, ...)
          { ... }
      - pattern: $JDBC_TEMPLATE.query(...)
      - pattern: $JDBC_TEMPLATE.queryForObject(...)
      - pattern: $JDBC_TEMPLATE.queryForList(...)
      - pattern: $JDBC_TEMPLATE.queryForMap(...)
      - pattern: $JDBC_TEMPLATE.queryForRowSet(...)
      - pattern: $JDBC_TEMPLATE.queryForStream(...)
      - pattern: $JDBC_TEMPLATE.update(...)
      - pattern: $JDBC_TEMPLATE.execute(...)
      - pattern: $ENTITY_MANAGER.createQuery(...)
      - pattern: $ENTITY_MANAGER.createNativeQuery(...)
      - pattern: $SESSION.createQuery(...)
      - pattern: $SESSION.createSQLQuery(...)
      - pattern: $SESSION.createFilter(...)
      - pattern: $MAP.get(...)
      - pattern: $MAP.getOrDefault(...)
      - pattern: $MAP.keySet()
      - pattern: $MAP.values()
      - pattern: $MAP.entrySet()
      - patterns:
          - pattern: $RETURNTYPE $FOO(..., $X, ...){ ... }
          - focus-metavariable: $X

    pattern-sinks:
      # DocumentBuilderFactory
      - patterns:
          - pattern-inside: >
              DocumentBuilderFactory $DBF =
              DocumentBuilderFactory.newInstance();

              ...
          - pattern: |
              DocumentBuilder $DB = $DBF.newDocumentBuilder();
              ...
              $DB.parse(..., $SINK, ...);
          - focus-metavariable: $SINK
      
      # SAXParser
      - patterns:
        - pattern-inside: |
            SAXParserFactory $SPF = SAXPasrerFactory.newInstance();
            ...
        - pattern: |
            SAXParser $SP = $SPF.newSAXParser();
            ...
            $SP.parse(..., $SINK, ...);
        - focus-metavariable: $SINK

      # XMLInputFactory
      - patterns:
          - pattern-inside: |
              XMLInputFactory $FACTORY = XMLInputFactory.newInstance();
              ...
          - pattern: $FACTORY.createXMLStreamReader(...);

      # Transformer (XSLT)
      - patterns:
        - pattern-inside: |
            TransformerFactory $TF = TransformerFactory.newInstance();
            ...
        - pattern: |
            Transformer $TRANSFORMER = $TF.newTransformer(...);
            ...
            $TRANSFORMER.transform(..., $SINK, ...);
        - focus-metavariable: $SINK
    
      # SchemaFactory (XSD Validation)
      - patterns:
        - pattern-inside: |
            SchemaFactory $SF = SchemaFactory.newInstance("http://www.w3.org/2001/XMLSchema");
            ...
        - pattern: |
            Schema $SCHEMA = $SF.newSchema(...);
            ...
            Validator $VALIDATOR = $SCHEMA.newValidator();
            ...
            $VALIDATOR.validate(..., $SINK, ...);
        - focus-metavariable: $SINK

      # XXE with XPATH
      - patterns:
        - pattern-inside: |
            XPathFactory $XPF = XPathFactory.newInstance();
            ...
        - pattern: |
            XPath $XPATH = $XPF.newXPath();
            ...
            $XPATH.evaluate(..., $SINK, ...);
        - focus-metavariable: $SINK

    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-611: Improper Restriction of XML External Entity Reference"
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      owasp:
        - A4:2017 XML External Entities (XXE)
