rules:
  - id: javascript-taint-063-lack-of-data-validation-path-traversal
    languages:
      - javascript
      - typescript
    severity: MEDIUM
    message: >
      The software uses external input to construct a pathname that is intended
      to identify a file, directory or URL but it does not properly neutralize or
      validate special elements within the pathname.
    mode: taint
    paths:
      exclude:
        - "*.tsx"
        - "*.jsx"
    pattern-sources:
      - pattern: req.body
      - pattern: req.query
      - pattern: req.params
      - pattern: request.body
      - pattern: request.query
      - pattern: request.params
      - patterns:
        - pattern-either:
          - pattern: function $FUNC(..., $SOURCE, ...)
          - pattern: const $FUNC = function (..., $SOURCE, ...) { ... }
          - pattern: app.$HTTPMETHOD('...', (..., $SOURCE, ...) => {...})
          - pattern: module.exports = async function $FUNC(..., $SOURCE, ...){...};
        - focus-metavariable: $SOURCE
    
    pattern-sanitizers:
      - pattern: path.basename(...)

    pattern-sinks:
        # FILENAME CREATIONS SINKS
        - patterns:
          - pattern-either:
            - pattern: $FILENAME = ...
          - metavariable-regex:
              metavariable: $FILENAME
              regex: (file(name)?|file_path|filepath|path|fileName|filePath|upload(ed)?File|docname?|attachment|report|output(file)?|input(file)?|csv(file)?|pdffile?|image(file)?|img(file)?|logfile?|archive|zip(file)?)

        # FILE OPERATIONS FUNCTIONS SINK
        - patterns: 
            - pattern-either:
                - pattern: path.join(..., $SINK)
                - pattern: fs.writeFile($SINK, ...)
                - pattern: fs.writeFileSync($SINK, ...)
                - pattern: fs.readFile($SINK, ...)
                - pattern: fs.readFileSync($SINK, ...)
                - pattern: fs.exists($SINK)
                - pattern: fs.existsSync($SINK)
                - pattern: fs.createReadStream($SINK)
                - pattern: fs.createWriteStream($SINK)
                
                - pattern: require($SINK)
                - pattern: $RES.sendFile($SINK)
            - focus-metavariable: $SINK
        
        # URL CREATIONS SINKS
        - pattern-either:
            - patterns:
              - pattern-either:
                  - pattern: $AXIOS.$METHOD(`...${$SINK}`, ...)
                  - pattern: $AXIOS.$METHOD(`...${$SINK}...`, ...)
              - focus-metavariable: $SINK
              - metavariable-regex:
                  metavariable: $METHOD
                  regex: (get|post|put)
              - metavariable-regex:
                  metavariable: $AXIOS
                  regex: (axios|axiosMonitorV1)
            
            - patterns:
              - pattern-either:
                - pattern: $URL = ...
              - metavariable-regex:
                  metavariable: $URL
                  regex: (url|uri|link|href|endpoint|baseurl|base_url|apiurl|api_url|callback(url)?|redirect(url)?|return(url)?|target(url)?|requesturl?|service(url)?|host|origin|webhook(url)?|resource(url)?)

    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')"
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: MEDIUM
      technology:
        - nodejs
        - expressjs
