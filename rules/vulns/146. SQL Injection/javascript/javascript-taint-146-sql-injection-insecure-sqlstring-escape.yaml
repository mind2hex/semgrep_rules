rules:
  - id: javascript-tainted-insecure-sqlstring-escape-implementation
    languages: [javascript, typescript]
    severity: ERROR
    message: |
      Insecure usage of SqlString.escape inside single quotes.
      SqlString.escape() already returns a quoted string, so wrapping it in single quotes causes
      double quoting (''value'') and may result in SQL logic or injection issues.
      Example:
        BAD:  date '${SqlString.escape(userInput)}'
        GOOD: date ${SqlString.escape(userInput)}
    metadata:
      cwe: "CWE-89: SQL Injection"
      owasp: "A03:2021 - Injection"
      category: security
      technology: [nodejs, javascript, sql]
      confidence: HIGH
    mode: taint
    pattern-sources:
      - pattern: req.body
      - pattern: req.query
      - pattern: req.params
      - pattern: request.body
      - pattern: request.query
      - pattern: request.params
      - patterns: 
        - pattern: function $FUNC(..., $SINK, ...)
        - focus-metavariable: $SINK
      - patterns:
          - pattern: const $FUNC = function (..., $PARAM, ...) { ... }
          - focus-metavariable: $PARAM
      - patterns:
          - pattern: app.$HTTPMETHOD('...', (..., $SOURCE, ...) => {...})
          - focus-metavariable: $SOURCE
      - patterns:
          - pattern: module.exports = async function $FUNC(..., $SOURCE, ...){...};
          - focus-metavariable: $SOURCE
      

    pattern-sinks:
      - pattern-either:
          - patterns:
            - pattern-inside: |
                `...`
            - pattern-regex: \'\$\{.*\}\'
            - pattern-either:
              - pattern: $SQLSTRING.escape($OBJ)
          
    # fix: "NO FIX YET"
    # arrow methods inside classes are not being detected