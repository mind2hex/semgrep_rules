rules:
  - id: java-pattern-146-sql-injection-spring-data-jpa
    languages:
      - java
    severity: HIGH
    message: |
      Possible SQL Injection in Spring Data JPA native query.
      This @Query uses string concatenation to build SQL while nativeQuery=true,
      which bypasses prepared statement protections and may allow attacker-controlled
      input to modify the executed SQL. Use named parameters (:param) without string
      concatenation.

    patterns:
      - pattern-inside: |
          @Query(value=..., nativeQuery=true)
      - pattern: |
          $SQL + $SINK
      - metavariable-regex:
          metavariable: $SINK
          regex: '^[a-zA-Z_][a-zA-Z0-9_]*$'
      - metavariable-regex:
          metavariable: $SINK
          regex: '^(?!:).*$'
      - focus-metavariable: $SINK


    metadata:
        category: security
        subcategory:
            - vuln
        cwe:
            - "CWE-89: Improper Neutralization of Special Elements used in an SQL Command ('SQL Injection')"
        confidence: MEDIUM
        likelihood: MEDIUM
        impact: HIGH
        owasp:
            - A3:2021 Injection
