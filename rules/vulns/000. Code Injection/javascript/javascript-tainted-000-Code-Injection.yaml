rules:
  - id: javascript-tainted-000-code-injection
    languages:
      - javascript
      - typescript
    severity: HIGH
    message: >-
      User-controlled input is being used to build or execute program code. This can let an attacker inject arbitrary code or alter application logic. Validate and sanitize inputs and avoid dynamic code evaluation.
    mode: taint
    pattern-sources:
      - pattern: req.body
      - pattern: req.query
      - pattern: req.params
      - pattern: request.body
      - pattern: request.query
      - pattern: request.params
      - patterns: 
        - pattern: function $FUNC(..., $SINK, ...)
        - focus-metavariable: $SINK
      - patterns:
          - pattern: const $FUNC = function (..., $PARAM, ...) { ... }
          - focus-metavariable: $PARAM
      - patterns:
          - pattern: app.$HTTPMETHOD('...', (..., $SOURCE, ...) => {...})
          - focus-metavariable: $SOURCE
      - patterns:
          - pattern: module.exports = async function $FUNC(..., $SOURCE, ...){...};
          - focus-metavariable: $SOURCE
          
    pattern-sanitizers:
      - pattern: parseInt(...)
      - pattern: JSON.stringify(...)
      - pattern: Number(...)
      - pattern: encodeURIComponent(...)
      - pattern: Boolean(...)
      - pattern: parseFloat(...)
      - pattern: validator.isInt(...)
      - pattern: DOMPurify.sanitize(...)

    pattern-sinks:
      
      # simple eval
      - pattern: eval(...)

      # Function constructor
      - patterns:
        - pattern-either:
          - pattern: new Function(..., $SINK);
          - pattern: Function(..., $SINK);
          - pattern: new Object.getPrototypeOf(function(){}).constructor(..., $SINK)
          - pattern: Object.getPrototypeOf(function(){}).constructor(..., $SINK)
          - pattern: new (async function(){}).constructor.constructor(..., $SINK)
          - pattern: (async function(){}).constructor.constructor(..., $SINK)
        - focus-metavariable: $SINK
      
      # vm module (Node.js)
      - patterns:
        - pattern-either:
          - pattern: |
              $VM.runInThisContext(...)
          - pattern: |
              $VM.runInNewContext(...)
          - pattern: |
              $VM.runInContext(...)
          - pattern: |
              $VM.Script(...)
          - pattern: |
              new $VM.Script(...)

      # dynamic import
      - patterns:
        - pattern-either:
          - pattern: |
              require(...)
          - pattern: |
              import(...)
      
      # web assembly
      - patterns:
        - pattern-either:
          - pattern: |
              WebAssembly.instantiate(...)
          - pattern: |
              WebAssembly.compile(...)

      # Worker threads con eval-like behavior
      - patterns:
        - pattern-either:
            - pattern: |
                new Worker(..., { eval: true })

      # Timer functions con strings (code injection)
      - patterns:
        - pattern-either:
          - pattern: setTimeout($SINK, ...)
          - pattern: setInterval($SINK, ...)
          - pattern: setImmediate($SINK)
        - pattern-not: |
            setTimeout($FUNCTION(...), ...)
        - pattern-not: |
            setInterval($FUNCTION(...), ...)
        - focus-metavariable: $SINK

      # GeneratorFunction
      - patterns:
        - pattern-either:
          - pattern: |
              $FOO = (function*(){}).constructor;
              ...
              $FOO(..., $SINK)

          - pattern: |
              $FOO = (function*(){}).constructor;
              ...
              new $FOO(..., $SINK);
              
          - pattern: |
              $FOO = Object.getPrototypeOf(function*(){}).constructor;
              ...
              $FOO(..., $SINK)
          
          - pattern: |
              $FOO = Object.getPrototypeOf(function*(){}).constructor;
              ...
              new $FOO(..., $SINK)
        - focus-metavariable: $SINK

      # AsyncGeneratorFunction
      - patterns:
        - pattern-either:
          - pattern: (async function*(){}).constructor(...)
          - pattern: new (async function*(){}).constructor(...)

      - patterns:        
        - pattern: |
            $REPL = require('repl');
            ...
            $REPLSRV = $REPL.start();
            ...
            $REPLSRV.eval($SINK, ...)
        - focus-metavariable: $SINK


      # Constructor chains
      - pattern: $OBJ.constructor.constructor(...)
      - pattern: (()=>{}).constructor.constructor(...)
      - pattern: ({}).constructor.constructor(...)
 
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-94: Improper Control of Generation of Code ('Code Injection')"
      confidence: MEDIUM
      likelihood: LOW
      impact: HIGH
      owasp:
        - A3:2021 Injection
