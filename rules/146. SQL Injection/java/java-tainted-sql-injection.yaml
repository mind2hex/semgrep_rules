rules:
  - id: java-tainted-sql-injection
    languages:
      - java
    severity: ERROR
    message: |
      Semgrep found a possibly sql injection vulnerability using taint analysis.
    pattern-sources:
      # javax.servlet.http.HttpServletRequest
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()
        - pattern: $REQUEST.getQueryString()
        - pattern: $REQUEST.getHeader(...)
        - pattern: $REQUEST.getHeaders(...)
        - pattern: $REQUEST.getCookies()

      # javax.servlet.ServletRequest
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()
        - pattern: $REQUEST.getQueryString()
        - pattern: $REQUEST.getInputStream()
        - pattern: $REQUEST.getReader()

      # java.sql.ResultSet
      - pattern-either:
        - pattern: $RESULT_SET.getString(...)
        - pattern: $RESULT_SET.getObject(...)
        - pattern: $RESULT_SET.getInt(...)
        - pattern: $RESULT_SET.getLong(...)
        - pattern: $RESULT_SET.getFloat(...)
        - pattern: $RESULT_SET.getDouble(...)
        - pattern: $RESULT_SET.getBigDecimal(...)
        - pattern: $RESULT_SET.getDate(...)
        - pattern: $RESULT_SET.getTime(...)
        - pattern: $RESULT_SET.getTimestamp(...)

      # org.springframework.web.servlet.mvc.Controller
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()

      # org.springframework.web.bind.annotation.RequestParam
      - pattern-either:
        - pattern: public $RETURN_TYPE $METHOD_NAME(..., @RequestParam(...) $PARAM, ...) { ... }

      # org.springframework.web.bind.annotation.PathVariable
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @PathVariable(...) $PARAM, ...) { ... }

      # org.springframework.web.bind.annotation.RequestBody
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @RequestBody $PARAM, ...) { ... }

      # org.springframework.web.bind.annotation.ModelAttribute
      - pattern: public $RETURN_TYPE $METHOD_NAME(..., @ModelAttribute(...) $PARAM, ...) { ... }

      # org.springframework.jdbc.core.JdbcTemplate
      - pattern: $JDBC_TEMPLATE.query(...)
      - pattern: $JDBC_TEMPLATE.queryForObject(...)
      - pattern: $JDBC_TEMPLATE.queryForList(...)
      - pattern: $JDBC_TEMPLATE.queryForMap(...)
      - pattern: $JDBC_TEMPLATE.queryForRowSet(...)
      - pattern: $JDBC_TEMPLATE.queryForStream(...)
      - pattern: $JDBC_TEMPLATE.update(...)
      - pattern: $JDBC_TEMPLATE.execute(...)

      # javax.persistence.EntityManager
      - pattern: $ENTITY_MANAGER.createQuery(...)
      - pattern: $ENTITY_MANAGER.createNativeQuery(...)

      # org.hibernate.Session
      - pattern: $SESSION.createQuery(...)
      - pattern: $SESSION.createSQLQuery(...)
      - pattern: $SESSION.createFilter(...)

      # java.util.Map
      - pattern: $MAP.get(...)
      - pattern: $MAP.getOrDefault(...)
      - pattern: $MAP.keySet()
      - pattern: $MAP.values()
      - pattern: $MAP.entrySet()

      - patterns:
        - pattern: $RETURNTYPE $FOO(..., $X, ...){ ... }
        - focus-metavariable: $X

    pattern-sinks:
      - patterns:
        - pattern-either:
          # string concatenation
          - pattern-either:
            - pattern: $VARTYPE $VAR = "$SQLSTR" + $TARGET;
            - pattern: $VARTYPE $VAR = "$SQLSTR" + $TARGET + ...;
          - pattern-either:
            - pattern: String.format("$SQLSTR", ...)
        - metavariable-regex:
            metavariable: $SQLSTR
            regex: "[ ]{0,1}(?i)(SELECT|INSERT|UPDATE|DELETE|WHERE|FROM|JOIN|AND|OR|HAVING|GROUP|ORDER|LIMIT|OFFSET|filter|clause|condition) .*"

    mode: taint
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-89: Improper Neutralization of Special Elements used in an SQL
          Command ('SQL Injection')"
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      owasp:
        - A3:2021 Injection
      technology:
        - flask
        - django
