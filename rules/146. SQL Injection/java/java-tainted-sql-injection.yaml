rules:
  - id: java-tainted-146-SQL-Injection
    languages:
      - java
    severity: ERROR
    message: |
      Dynamic SQL statements are generated without the required data validation and without using parameterized statements or stored procedures.
    pattern-sources:
      # javax.servlet.http.HttpServletRequest
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()
        - pattern: $REQUEST.getQueryString()
        - pattern: $REQUEST.getHeader(...)
        - pattern: $REQUEST.getHeaders(...)
        - pattern: $REQUEST.getCookies()

      # javax.servlet.ServletRequest
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()
        - pattern: $REQUEST.getQueryString()
        - pattern: $REQUEST.getInputStream()
        - pattern: $REQUEST.getReader()

      # java.sql.ResultSet
      - pattern-either:
        - pattern: $RESULT_SET.getString(...)
        - pattern: $RESULT_SET.getObject(...)
        - pattern: $RESULT_SET.getInt(...)
        - pattern: $RESULT_SET.getLong(...)
        - pattern: $RESULT_SET.getFloat(...)
        - pattern: $RESULT_SET.getDouble(...)
        - pattern: $RESULT_SET.getBigDecimal(...)
        - pattern: $RESULT_SET.getDate(...)
        - pattern: $RESULT_SET.getTime(...)
        - pattern: $RESULT_SET.getTimestamp(...)

      # org.springframework.web.servlet.mvc.Controller
      - pattern-either:
        - pattern: $REQUEST.getParameter(...)
        - pattern: $REQUEST.getParameterValues(...)
        - pattern: $REQUEST.getParameterMap()

      - patterns:
        - pattern: $RETURNTYPE $FOO(..., $X, ...){ ... }
        - focus-metavariable: $X

    pattern-sinks:
      - patterns:
        - pattern-either:
          # string concatenation
          - pattern-either:
            - pattern: |
                "$SQLSTR" + $TARGET
            - pattern: |
                "$SQLSTR" + $TARGET + ...
          - pattern-either:
            - pattern: String.format("$SQLSTR", ...)
            - patterns:
              - pattern: |
                  "$SQLSTR".replace("...", $SINK)
              - focus-metavariable: $SINK
        - metavariable-regex:
            metavariable: $SQLSTR
            regex: 
              "(?i)(?i)^\\s*(SELECT|INSERT|UPDATE|DELETE|WHERE|FROM|JOIN|AND|OR|HAVING|GROUP|ORDER|LIMIT|OFFSET|FILTER|CAUSE|CONDITION) .*"
              
    mode: taint
    metadata:
      category: security
      subcategory:
        - vuln
      cwe:
        - "CWE-89: Improper Neutralization of Special Elements used in an SQL
          Command ('SQL Injection')"
      confidence: MEDIUM
      likelihood: MEDIUM
      impact: HIGH
      owasp:
        - A3:2021 Injection
      technology:
        - flask
        - django
