rules:
  - id: python-000-Code-Injection
    languages: 
      - python
    severity: CRITICAL
    message: >-
      User-controlled input is being used to build or execute program code. This can let an attacker inject arbitrary code or alter application logic. Validate and sanitize inputs and avoid dynamic code evaluation.
    mode: taint
    pattern-sources:
      - patterns:
          - pattern: request.$METHOD
          - metavariable-regex:
              metavariable: $METHOD
              regex: (GET|POST|body|path|path_info|content_params|query_params|data|FILES|META|headers|COOKIES|args|form|files|values|json|get_json|cookies|view_args|path_params|file|state|params|matchdict|json_body|query|forms|get_data)
      - patterns:
          - pattern: self.request.$METHOD
          - metavariable-regex:
              metavariable: $METHOD
              regex: (arguments|query_arguments|body_arguments|files|path_args|path_kwargs|headers|cookies)
      - pattern: self.get_argument(...)
      - patterns:
          - pattern: |
              def $FOO(..., $X, ...):
                ...
          - focus-metavariable: $X

    pattern-sinks:
      - pattern: eval(...)
      - pattern: exec(...)
      - pattern: compile(...)
      - pattern: importlib.import_module(...)
      - patterns: 
        - pattern: getattr(..., $ATTR)
        - focus-metavariable: $ATTR
      - pattern: __import__(...)
      - pattern: jinja2.Template(...)
      - pattern: pickle.loads(...)
      - pattern: yaml.load(...)
      - pattern: marshal.loads(...)
      - patterns: 
          - pattern: |
              $FOO = pandas.DataFrame(...)
              ...
          - pattern: $FOO.eval(...)
      - patterns: 
        - pattern: timeit.timeit($OBJ, ...)
        - focus-metavariable: $OBJ
              